!function(t){var e={};function o(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=t,o.c=e,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(i,r,function(e){return t[e]}.bind(null,r));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/",o(o.s=98)}({19:function(e,o,i){"use strict";i.d(o,"b",(function(){return p})),i.d(o,"a",(function(){return v}));var r=i(21);function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function a(t,e){return!e||"object"!==s(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function u(t,e,o){return e&&c(t.prototype,e),o&&c(t,o),t}var f=function(){function e(){var o=this;h(this,e),this.addToListAfterLoad=!0,this.uploadableBase64=null,this.hasError=!1,this.textError="",this.html=$('<div class="draggable-block item">\n\t\t\t<div class="clickable">\n\t\t\t\t<div class="image draggable-anchor">\n\t\t\t\t\t<div class="thumbnail-img-load">\n\t\t\t\t\t\t<div class="ispinner-lite"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<img src="" alt="">\n\t\t\t\t\t<div class="progress">\n\t\t\t\t\t\t<div></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="controls">\n\t\t\t\t\t<a class="upload">'+t("Изменить")+'</a>\n\t\t\t\t\t<a class="delete">'+t("Удалить")+'</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="draggable-block_error"></div>\n\t\t\t</div>\n\t\t</div>'),this.html.find(".draggable-anchor").on("mousedown",(function(t){return o.onDragStart(t),!1})),this.html.find(".image").find("img").on("load",(function(t){var e=$(this);e.hasClass("isNotCrop")&&e.get(0).width>e.get(0).height&&e.get(0).height/e.get(0).width<.665&&e.addClass("isHorizontalImg")}))}return u(e,[{key:"updateImage",value:function(){var t=this.getImageSrc();t&&this.addImage(t)}},{key:"addImage",value:function(t){this.data.urlBig&&this.data.url&&this.data.urlBig==this.data.url?this.html.find(".image").addClass("uploaded").find("img").addClass("isNotCrop"):this.data.cover&&this.data.cover.urlBig&&this.data.cover.url&&this.data.cover.urlBig==this.data.cover.url?this.html.find(".image").addClass("uploaded").find("img").addClass("isNotCrop"):null===this.data.urlBig&&null===this.data.urlBig&&this.html.find(".image").addClass("uploaded").find("img").addClass("isNotCrop"),this.html.find(".image").addClass("uploaded").find("img").attr("src",t)}},{key:"applyErrors",value:function(e){var o=this;this.hasError=e.length>0,this.backendErrors={};var i="",r=t("Видео требует исправлений!"),s=t("Исправьте ошибки в портфолио!"),a=!1,l=!1;$.each(e,(function(t,e){"position"in e?(e.target in o.backendErrors||(o.backendErrors[e.target]={}),o.backendErrors[e.target][e.position]=e.text):(e.target in o.backendErrors||(o.backendErrors[e.target]=[]),o.backendErrors[e.target].push(e.text)),"images"!=e.target&&"cover"!=e.target||(l=!0),"videos"!=e.target&&"video"!=e.target||(a=!0)})),"photo"==window.portfolioType?(l&&(i="<div>"+s+"</div>"),a&&(i+="<div>"+r+"</div>")):"video"==window.portfolioType&&(a&&(i="<div>"+r+"</div>"),l&&(i+="<div>"+s+"</div>")),this.updateErrorVisuals(i)}},{key:"updateErrorVisuals",value:function(t){this.hasError?(this.html.addClass("error"),this.html.find(".draggable-block_error").html(t)):(this.html.removeClass("error"),this.html.find(".draggable-block_error").html(""))}},{key:"showProgress",value:function(){this.updateProgress(0),this.html.addClass("loading")}},{key:"hideProgress",value:function(){this.html.removeClass("loading")}},{key:"updateProgress",value:function(t){this.html.find(".progress div").css({width:t+"%"})}}]),e}(),p=function(t){function e(t){var o;return h(this,e),(o=a(this,l(e).call(this))).blank=!1,o.deleteModal=$(".portfolio-delete-modal-confirm"),o.data={id:null,draftHash:null,cover:{id:null,crop:null,hash:null,url:null},title:"",images:[],videos:[],description:""},t?($.extend(o.data,t),o.addToListAfterLoad=!1):o.blank=!0,o.backendErrors={},o.updateImage(),o.html.find(".upload").on("click",(function(){o.onEdit()})),o.html.find(".delete").on("click",(function(){o.deleteModal.modal("show"),o.deleteModal.find(".js-confirm-portfolio-delete").off().on("click",(function(){o.portfolioDelete(),o.deleteModal.modal("hide")})),o.deleteModal.find(".js-continue-portfolio-delete").off().on("click",(function(){o.deleteModal.modal("hide")}))})),o}return n(e,t),u(e,[{key:"portfolioDelete",value:function(){if(window.portfolioList.modal.page!=window.portfolioList.modal.PAGE_KWORK){var t=new FormData;t.append("portfolio_id",this.data.id),t.append("unlink","true"),$.ajax({url:"/portfolio/delete",data:t,async:!0,contentType:!1,processData:!1,type:"POST",complete:function(t,e){var o={};try{o=JSON.parse(t.responseText)}catch(t){}"success"in o&&1==o.success&&(window.location=window.location.href)}})}else this.onDelete()}},{key:"getImageSrc",value:function(){return this.data.cover&&this.data.cover.url?this.data.cover.url:null}},{key:"parseBackendErrors",value:function(t){var e=this;this.backendErrors={},$.each(t,(function(t,o){!o.target in e.backendErrors&&(e.backendErrors[o.target]=[]),e.backendErrors[o.target]=o.text}))}},{key:"getData",value:function(t){var e=$.extend(!0,{},t||this.data);return delete e.cover.url,delete e.cover.urlBig,delete e.cover.urlDefault,delete e.cover.hash,$.each(e.images,(function(t,o){e.images[t]=o.id})),e}}]),e}(f),v=function(t){function e(t){var o;h(this,e),(o=a(this,l(e).call(this))).data={id:null,hash:null,url:null,urlBig:null},t&&($.extend(o.data,t),o.addToListAfterLoad=!1),o.updateImage(),o.progress=o.html.find(".progress"),o.progressBar=o.progress.find("div"),o.fileUploader=new r.a,o.fileUploader.url="/portfolio/upload_image",o.fileUploader.fileName="file",o.fileUploader.maxSize=10485760,o.fileUploader.minImageWidth=660,o.fileUploader.minImageHeight=440,o.fileUploader.maxImageWidth=6e3,o.fileUploader.maxImageHeight=6e3,o.fileUploader.mimeTypes=["image/jpeg","image/png","image/gif"],window.kworkId&&window.portfolioList.modal.page===window.portfolioList.modal.PAGE_KWORK&&(o.fileUploader.postData.kwork_id=window.kworkId);var i=window.portfolioList.getImagesHashes().concat(window.portfolioList.getCoverHashes());window.portfolioList.modal.portfolio.cover.hash&&i.push(window.portfolioList.modal.portfolio.cover.hash),window.firstPhotoHash&&i.push(window.firstPhotoHash),i.length&&$.each(i,(function(t,e){o.fileUploader.postData["hashes["+t+"]"]=e}));var s=window.portfolioList.modal.portfolio.id;return s&&(o.fileUploader.postData.portfolio_id=s),o.fileUploader.onLoad=function(t){o.uploadableBase64=t,o.onLoadStart(),o.onChangeState(),o.updateImage(),o.showProgress(),o.addToListAfterLoad&&(o.onLoad(),o.onChangeState(),o.addToListAfterLoad=!1)},o.fileUploader.onProgress=function(t){o.updateProgress(t)},o.fileUploader.onSuccess=function(t){o.data.id=t.id,o.data.url=o.uploadableBase64,o.data.urlBig=o.uploadableBase64,o.data.hash=t.hash,o.uploadableBase64=null,o.onChangeState(),o.hideProgress(),o.onSuccess()},o.fileUploader.onError=function(t){if(!o.addToListAfterLoad&&!o.data.url)return o.onDelete(),o.onChangeState(),void o.onError(t);o.uploadableBase64=null,o.onChangeState(),o.updateImage(),o.hideProgress(),o.onError(t)},o.fileUploader.onFail=function(t){o.fileUploader.onError(t)},o.html.find(".upload").on("click",(function(){o.fileUploader.upload()})),o.html.find(".delete").on("click",(function(){o.fileUploader.abort(),o.onDelete()})),o}return n(e,t),u(e,[{key:"getImageSrc",value:function(){return this.uploadableBase64?this.uploadableBase64:this.data.url?this.data.url:null}}]),e}(f)},21:function(e,o,i){"use strict";function r(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var s;i.d(o,"a",(function(){return a}));var a=function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.url="/",this.fileName="file",this.postData={},this.aborted=!1,this.maxFileSize=10485760,this.minImageWidth=660,this.minImageHeight=440,this.maxImageWidth=6e3,this.maxImageHeight=6e3,this.errors={bigFilesize:"Превышен максимально допустимый объём файла!",incorrectType:"Некорректный тип файла!"},this.extensions={"image/jpeg":["jpg","jpeg"],"image/gif":["gif"],"image/png":["png"]},this.mimeTypes=null,this.onError=function(){},s?this.input=s:((s=$('<input type="file" class="d-none" />')).prependTo("body"),this.input=s,this.input.on("change",(function(t){$(t.target).data("loadHandler").fileUpload(t)})))}var o,i,a;return o=e,(i=[{key:"getExtensions",value:function(){var t=this;if(!this.mimeTypes)return"";var e=[];return $.each(this.mimeTypes,(function(o,i){i in t.extensions&&(e=e.concat(t.extensions[i]))})),$.each(e,(function(t,o){e[t]="."+o})),e.join(",")}},{key:"upload",value:function(){this.input.attr("accept",this.getExtensions()),this.input.data("loadHandler",this),this.input.trigger("click")}},{key:"fileUpload",value:function(){var e=this;this.abort();var o=this.input.get(0).files[0];this.input.val(""),o.size>this.maxFileSize?this.onError&&this.onError(t(this.errors.bigFilesize)):this.mimeTypes&&-1==$.inArray(o.type,this.mimeTypes)?this.onError&&this.onError(t(this.errors.incorrectType)):this.readPhotoForPreview(o,(function(){e.fileUploadAjax(o)}))}},{key:"fileUploadAjax",value:function(t){var e=this,o=new FormData;$.each(this.postData,(function(t,e){o.append(t,e)})),o.append(this.fileName,t),this.xhr=$.ajax({xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",(function(t){if(t.lengthComputable){var o=parseInt(t.loaded/t.total*100);e.onProgress&&e.onProgress(o)}}),!1),t},url:this.url,data:o,async:!0,contentType:!1,processData:!1,type:"POST",complete:function(t,o){if(!e.aborted){var i={};try{i=JSON.parse(t.responseText)}catch(t){}"success"in i&&1==i.success?e.onSuccess&&e.onSuccess(i.data):e.onFail&&e.onFail(i.data)}}})}},{key:"readPhotoForPreview",value:function(e,o){var i=this,r=new FileReader;r.onload=function(){var e=new Image;e.src=r.result,e.onload=function(){i.checkMinImageResolution(e)?i.checkMaxImageResolution(e)?(i.onLoad&&i.onLoad(e.src),o()):i.onError(t("Размер изображения должен быть не больше ")+i.maxImageWidth+"x"+i.maxImageHeight+t(" пикселей")):i.onError(t("Размер изображения должен быть не меньше ")+i.minImageWidth+"x"+i.minImageHeight+t(" пикселей"))}},r.readAsDataURL(e)}},{key:"checkMinImageResolution",value:function(t){return!(t.width<this.minImageWidth||t.height<this.minImageHeight)}},{key:"checkMaxImageResolution",value:function(t){return!(t.width>this.maxImageWidth||t.height>this.maxImageHeight)}},{key:"abort",value:function(){this.xhr&&(this.aborted=!0,this.xhr.abort(),this.aborted=!1)}}])&&r(o.prototype,i),a&&r(o,a),e}()},22:function(e,o,i){"use strict";i.d(o,"a",(function(){return n}));var r=i(50),s=i(21);function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function l(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var n=function(){function e(){var t=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.portfolioType=window.portfolioType||"photo",this.PORTFOLIO_TYPE_PHOTO="photo",this.PORTFOLIO_TYPE_VIDEO="video",this.COVER_IMAGE_TYPE_VIDEO="video",this.COVER_IMAGE_TYPE_IMAGE="image",this.COVER_IMAGE_TYPE_UPLOAD="upload",this.MAX_YOUTUBE=5,this.MIN_WIDTH_CROP_BOX=660,this.MIN_HEIGHT_CROP_BOX=440,this.PAGE_ORDER="track",this.PAGE_KWORK="edit-kwork",this.PAGE_MY_PORTFOLIO="my-portfolios",this.block=$(".portfolio-upload-modal"),this.titleInput=this.block.find('input[name="title"]'),this.fieldKworks=this.block.find(".js-field-kworks"),this.fieldOrders=this.block.find(".js-field-orders"),this.coverUploadGrid=this.block.find(".js-cover-upload-grid"),this.coverTextNotLoad=this.block.find(".js-portfolio-cover-text-not-load"),this.coverTextLoad=this.block.find(".js-portfolio-cover-text-load"),this.exampleCard=this.block.find(".portfolio-example-card"),this.exampleCardCntLikes=this.exampleCard.find(".cnt-likes"),this.exampleCardCntViews=this.exampleCard.find(".cnt-views"),this.exampleCardCntComments=this.exampleCard.find(".cnt-comments"),this.exampleCardName=this.exampleCard.find(".portfolio-card-name"),this.exampleCardCategory=this.exampleCard.find(".portfolio-card-content--category"),this.exampleCardThumbnail=this.exampleCard.find(".portfolio-cropper-preview"),this.confirmBlock=$(".portfolio-upload-modal-confirm"),this.confirmAtClose=!0,this.reloadAfterSave=this.block.data("portfolioReloadAfterSave")||!1,this.page=this.block.data("portfolioPage"),this.orderId=this.block.data("orderId"),this.requiredPortfolioType=this.block.find(".js-required-portfolio-type"),this.secondaryPortfolioType=this.block.find(".js-secondary-portfolio-type"),this.fieldImages=this.block.find(".js-field-images"),this.fieldVideos=this.block.find(".js-field-videos"),this.attributesLoaded=!0,this.kworksList={},this.ordersList={},this.errorFields=[],this.classes={field:"js-field",fieldCounter:"js-field-counter",fieldCounterHint:"js-field-counter-hint",btnSave:"js-save-portfolio",btnDisabled:"btn_disabled",inputClassError:"input-error-portfolio",videos:"videos",fieldYoutube:"youtube-field",youtubeRemove:"js-youtube-remove",btnCloseConfirm:"js-confirm-portfolio",btnCloseContinue:"js-continue-portfolio",cover:"js-portfolio-cover",coverUploadField:"js-cover-upload-field",coverImage:"js-cover-image",coverBtnUpload:"js-portfolio-cover-upload",coverMini:"js-cover-mini",categoryError:"js-category-error",attributesError:"js-attributes-error",kworkError:"js-portfolio-kwork-error",coverError:"js-portfolio-cover-error",titleError:"js-portfolio-title-error",imagesError:"sortable-card-list .portfolio-error",videosError:"js-portfolio-videos-error",selectKwork:"js-portfolio-kwork",selectOrder:"js-portfolio-order",selectParentCategories:"js-portfolio-parent-categories",selectCategories:"js-portfolio-categories",attributes:"js-attributes",linkShowImages:"js-portfolio-images-link",linkShowVideos:"js-portfolio-videos-link"},this.frontendErrors={title:[],cover:[],images:[],videos:[]},this.coverCropper="",this.cropperConfig={checkCrossOrigin:!1,checkOrientation:!1,background:!0,rotatable:!1,scalable:!1,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,toggleDragModeOnDblclick:!1,aspectRatio:1.5,autoCropArea:.8,preview:this.exampleCardThumbnail,viewMode:1,dragMode:"move"},this.initSortableContainer(),this.initCover(),this.events(),this.block.find("."+this.classes.selectParentCategories+", ."+this.classes.selectCategories).chosen({width:"100%",disable_search:!0,display_disabled_options:!1}),this.block.find("."+this.classes.selectKwork+", ."+this.classes.selectOrder).chosen({width:"100%",disable_search:!1,disable_search_threshold:10}),this.block.find("."+this.classes.selectOrder).on("keyup change chosen:showing_dropdown",(function(e){t.formatChosenList()}));var o=this.block.find("."+this.classes.selectOrder).parent();o.on("click",(function(e){o.hasClass("loaded")||t.getFullOrders(t.portfolio.kwork_id,(function(o){t.renderOrders(o.orders,null,!1,!0),$(e.target).find("select").trigger("mousedown").trigger("chosen:open"),t.formatChosenList()}))}))}var o,i,n;return o=e,(i=[{key:"formatChosenList",value:function(){$(".chosen-results .active-result").html((function(){var t=$(this).html();return/ \(/.test(t)?t=(t=t.replace(" (",'<div class="chosen-multiline">')+"</div>").replace(")",""):t}))}},{key:"initSortableContainer",value:function(){var t=this;this.sortableContainer=new r.a(this.block.find(".sortable-card-list")[0]),this.sortableContainer.onChangeState=function(){t.updateSaveButton(),t.updateImages(),t.validateImages()},this.sortableContainer.onSuccess=function(e){t.updateCoverMini(),t.portfolioItem.backendErrors.cover=[],(!t.portfolio.cover.urlBig||t.portfolio.cover.urlDefault!==t.portfolio.cover.urlBig&&1===t.portfolio.images.length)&&(t.updateCoverUrl(e.data.urlBig),t.updateCoverIdPortfolioImage(e.data.id),t.updateCoverBlock(),t.portfolio.cover.type=t.COVER_IMAGE_TYPE_IMAGE),t.setCoverMiniSelected(t.portfolio.cover.urlBig)},this.sortableContainer.onDelete=function(e){t.updateImages(),t.selectRandomCover(e.data.urlBig,!0)}}},{key:"initCover",value:function(){var e=this;this.coverUploader=new s.a,this.coverUploader.postData={validator:"KworkCover"},this.coverUploader.url="/temp-image-upload",this.coverUploader.fileName="file",this.coverUploader.maxSize=10485760,this.coverUploader.minImageWidth=660,this.coverUploader.minImageHeight=440,this.coverUploader.maxImageWidth=6e3,this.coverUploader.maxImageHeight=6e3,this.coverUploader.mimeTypes=["image/jpeg","image/png","image/gif"],this.coverUploader.errors.unknown=t("Произошла ошибка. Пожалуйста, попробуйте еще раз."),this.coverUploader.onError=function(t){e.hideCoverProgress(),e._unlockSaveBtn(),e.rollbackCover(),e.errorCover(t||e.coverUploader.errors.unknown)},this.coverUploader.onLoad=function(t){e.base64=t,e.updateCoverBlock(e.base64),e.showCoverProgress(),e._lockSaveBtn()},this.coverUploader.onProgress=function(t){e.updateCoverProgress(t)},this.coverUploader.onSuccess=function(t){e.portfolioItem.backendErrors.cover=[],e.portfolio.cover.id=t.id,e.portfolio.cover.hash=t.hash,e.portfolio.cover.urlDefault=e.base64,e.portfolio.cover.crop=null,e.portfolio.cover.type=e.COVER_IMAGE_TYPE_UPLOAD,e.updateCoverMini(),e.updateCoverUrl(e.base64),e.updateCoverIdPortfolioImage(),e.setCoverMiniSelected(e.base64),e.errorCover(),e.hideCoverProgress(),e._unlockSaveBtn()},this.coverUploader.onFail=function(t){e.hideCoverProgress(),e._unlockSaveBtn();var o="";$.each(t,(function(t,e){o+=e+"<br>"})),e.rollbackCover(),e.errorCover(o)},this.block.find("."+this.classes.coverImage).on("zoom","img",(function(t){var o=e.coverCropper.cropper("getData");t.originalEvent.detail.ratio>t.originalEvent.detail.oldRatio&&(o.width<e.MIN_WIDTH_CROP_BOX||o.height<e.MIN_HEIGHT_CROP_BOX)&&t.preventDefault()})),this.block.find("."+this.classes.coverUploadField).on("click",(function(){e.updateCoverCrop(),e.coverUploader.upload()})),this.block.find("."+this.classes.coverBtnUpload).on("click",(function(){e.updateCoverCrop();var t=window.portfolioList.modal.portfolio.id;t&&(e.coverUploader.postData.portfolio_id=t);var o=e.getImagesHashes().concat(e.getCoverHashes());e.portfolio.cover.hash&&o.push(e.portfolio.cover.hash),window.firstPhotoHash&&o.push(window.firstPhotoHash),o.length&&$.each(o,(function(t,o){e.coverUploader.postData["hashes["+t+"]"]=o})),e.coverUploader.upload()}))}},{key:"rollbackCover",value:function(){this.defaultCoverField(),this.clearExampleCardPreview(),this.portfolio.cover&&this.portfolio.cover.urlBig?(this.updateCoverUrl(this.portfolio.cover.urlBig),this.updateCoverIdPortfolioImage(this.portfolio.cover.idPortfolioImage),this.updateCoverBlock()):this.hideCoverUpload()}},{key:"clearCover",value:function(){this.defaultCoverField(),this.clearExampleCardPreview(),this.hideCoverUpload()}},{key:"selectRandomCover",value:function(t,e){var o=this;this.updateCoverMini(),this.block.find("."+this.classes.coverImage).find('img[src="'+t+'"]').length&&this.coverMini.length||this.coverMini[0]&&this.coverMini[0].url?(this.updateCoverUrl(this.coverMini[0].url),this.updateCoverIdPortfolioImage(this.coverMini[0].id),this.updateCoverBlock(),this.portfolio.cover.type=this.coverMini[0].type):0===this.coverMini.length&&(this.clearCover(),this.updateCoverUrl(""),this.updateCoverIdPortfolioImage(0),this.updateCoverHash(),delete this.portfolio.cover.type,e&&setTimeout((function(){o.updateYoutubeCover()}),0))}},{key:"defaultCoverField",value:function(){this.block.find("."+this.classes.coverImage).find("> *:not(.progress)").remove(),this.showCoverField(),this.hideCoverImage(),this.destroyCropper()}},{key:"updateCoverBlock",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.destroyCropper(),this.showCoverUpload(),this.errorCover();var o=this.block.find("."+this.classes.coverImage),i=o.find("img"),r=e||this.portfolio.cover.urlBig,s=this.portfolio.cover.crop?this.portfolio.cover.crop:"";this.showCoverImage(),this.hideCoverField(),i.length?i.attr("src",r):o.append(this._cropImgTpl(r)),o.find("img").ready((function(){t.initCropper(s)})),this.setCoverMiniSelected(r)}},{key:"initCropper",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=this.block.find("."+this.classes.coverImage),i=o.find("img");e?$("<img>").attr("src",i.attr("src")).load((function(o){var r=o.target.width,s=o.target.height;t.cropperConfig.data={x:e.x*r,y:e.y*s,width:Math.round(e.w*r),height:Math.round(e.h*s)},t.coverCropper=i.cropper(t.cropperConfig)})):(this.cropperConfig.data={},this.coverCropper=i.cropper(this.cropperConfig))}},{key:"getImgCropper",value:function(){if(!this.coverCropper)return!1;try{return this.coverCropper.cropper("getCroppedCanvas").toDataURL("image/jpeg")}catch(t){return!1}}},{key:"destroyCropper",value:function(){this.coverCropper&&(this.coverCropper.cropper("destroy"),this.coverCropper="")}},{key:"getCropperData",value:function(){if(!this.coverCropper)return!1;try{var t=this.coverCropper.cropper("getData"),e=this.coverCropper.cropper("getImageData");return{x:t.x/e.naturalWidth,y:t.y/e.naturalHeight,w:t.width/e.naturalWidth,h:t.height/e.naturalHeight}}catch(t){return{x:null,y:null,w:null,h:null}}}},{key:"errorCover",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=this.block.find("."+this.classes.coverError);e.html(t)}},{key:"showCoverTextLoad",value:function(){this.coverTextNotLoad.hide(),this.coverTextLoad.show()}},{key:"showCoverTextNotLoad",value:function(){this.coverTextNotLoad.show(),this.coverTextLoad.hide()}},{key:"showCoverUpload",value:function(){this.coverUploadGrid.addClass("show-cover-upload")}},{key:"hideCoverUpload",value:function(){this.coverUploadGrid.removeClass("show-cover-upload"),this.hideCoverMini()}},{key:"showCoverImage",value:function(){this.block.find("."+this.classes.coverImage).show()}},{key:"hideCoverImage",value:function(){this.block.find("."+this.classes.coverImage).hide()}},{key:"showCoverMini",value:function(){this.block.find("."+this.classes.coverMini).show(),this.coverUploadGrid.addClass("show-cover-mini")}},{key:"hideCoverMini",value:function(){this.block.find("."+this.classes.coverMini).hide(),this.coverUploadGrid.removeClass("show-cover-mini")}},{key:"showCoverField",value:function(){this.block.find("."+this.classes.coverUploadField).show()}},{key:"hideCoverField",value:function(){this.block.find("."+this.classes.coverUploadField).hide()}},{key:"showCoverProgress",value:function(){var t=this.block.find("."+this.classes.coverImage);this.updateCoverProgress(0),t.addClass("loading")}},{key:"hideCoverProgress",value:function(){this.block.find("."+this.classes.coverImage).removeClass("loading")}},{key:"updateCoverProgress",value:function(t){this.block.find("."+this.classes.coverImage).find(".progress div").css({width:t+"%"})}},{key:"clearCoverMini",value:function(){this.coverMini=[];var t=this.block.find("."+this.classes.coverMini);t.hasClass("slick-initialized")&&t.slick("unslick"),t.html("")}},{key:"updateCoverMini",value:function(){var t=this;this.clearCoverMini(),this.portfolio.cover&&this.portfolio.cover.urlDefault&&this.coverMini.push({id:0,url:this.portfolio.cover.urlDefault,type:this.COVER_IMAGE_TYPE_UPLOAD}),$.each(this.portfolio.images,(function(e,o){o.urlBig&&t.coverMini.push({id:o.id,url:o.urlBig,type:t.COVER_IMAGE_TYPE_IMAGE})})),this.portfolio.cover.urlFromVideo&&this.coverMini.push({id:0,url:this.portfolio.cover.urlFromVideo,type:this.COVER_IMAGE_TYPE_VIDEO}),this.addCoverMini(),this.initCoverSlick(),this.block.find("."+this.classes.coverMini).find(".preview").length>1?this.showCoverMini():this.hideCoverMini()}},{key:"addCoverMini",value:function(){var t=this;$.each(this.coverMini,(function(e,o){t.block.find("."+t.classes.coverMini).append('<div class="preview"><img src="'+o.url+'" alt="" data-id-image-portfolio="'+o.id+'"'+(o.type?' data-type="'+o.type+'"':"")+"></div>"),t.block.find("."+t.classes.coverMini).find(".preview").on("click",(function(e){t.updateCoverUrl($(e.target).attr("src")),t.updateCoverIdPortfolioImage($(e.target).data("idImagePortfolio")),t.updateCoverBlock(),t.portfolio.cover.type=$(e.target).data("type")}))}))}},{key:"setCoverMiniSelected",value:function(t){var e=this.block.find("."+this.classes.coverMini).find(".preview");e.removeClass("selected"),e.find("img").filter('[src="'+t+'"]').parents(".preview").addClass("selected")}},{key:"initCoverSlick",value:function(){this.coverMini.length>4&&this.block.find("."+this.classes.coverMini).slick({dots:!1,infinite:!0,slidesToShow:3,slidesToScroll:3,variableWidth:!0,centerMode:!0,focusOnSelect:!0,prevArrow:'<span class="cover-upload-mini__slick cover-upload-mini__slick-prev"><i class="fa fa-angle-left"></i></span>',nextArrow:'<span class="cover-upload-mini__slick cover-upload-mini__slick-next"><i class="fa fa-angle-right"></i></span>'})}},{key:"events",value:function(){var t=this;this.confirmBlock.find("."+this.classes.btnCloseConfirm).on("click",(function(e){t.confirmBlock.modal("hide"),t._modalHide()})),this.confirmBlock.find("."+this.classes.btnCloseContinue).on("click",(function(e){t.confirmBlock.modal("hide"),$("body").addClass("modal-open"),t.block.fadeIn(300)})),this.block.on("hide.bs.modal",(function(e){if(t.confirmAtClose){if(t.updateAll(),!1===t.isChangedPortfolio())return;t.setDefaultTitle(),e.preventDefault(),t.block.fadeOut(300),t.confirmBlock.modal("show")}})),this.block.find("."+this.classes.fieldCounter).on("input",(function(e){t.countCharacters($(e.target))})),this.titleInput.on("input",(function(){t.updateTitle(),t.validateTitle(),t.setExampleCardName()})),this.block.find("."+this.classes.btnSave).on("click",(function(e){$(e.target).hasClass("js-save-portfolio-for-draft")?t.save(!0):t.save()})),this.block.on("shown.bs.modal",(function(){t.sortableContainer.updateOffsets(),t.sortableContainer.updateAllBlockCoordinates()})),this.block.on("click","."+this.classes.youtubeRemove,(function(e){var o=$(e.target).closest("."+t.classes.fieldYoutube);t.youtubeRemove(o.find("input"))})),this.block.on("input","."+this.classes.fieldYoutube+" input",(function(e){t.youtubeEvents($(e.target))})),this.block.on("change","."+this.classes.selectKwork,(function(e){t.kworkChange()})),this.block.on("change","."+this.classes.selectOrder,(function(e){t.orderChange()})),this.block.on("change","."+this.classes.selectParentCategories,(function(e){t.portfolio.attributes_ids=[],t.renderCategories(),t.updateCategory(),t.validateCategory(),t.portfolio.attributes_ids=[],t.block.find("."+t.classes.attributes).html(""),t.renderAttributes(),t.renderKworksAndOrders(),t.setExampleCardCategory(),t.selectBlockVideosOrImages()})),this.block.on("change","."+this.classes.selectCategories,(function(e){t.updateCategory(),t.validateCategory(),t.portfolio.attributes_ids=[],t.block.find("."+t.classes.attributes).html(""),t.renderAttributes(),t.renderKworksAndOrders(),t.setExampleCardCategory(),t.selectBlockVideosOrImages()})),this.block.find("."+this.classes.attributes).on("change","input:radio",(function(e){var o=$(e.target).val(),i=$(e.target).closest(".js-field-block"),r=i.data("level");i.children(".js-attribute-section-block").empty(),t.updateAttributes(),t.renderAttributes(r,o),t.renderKworksAndOrders()})),this.block.find("."+this.classes.attributes).on("change","input:checkbox",(function(e){var o=$(e.target).val(),i=$(e.target).closest(".js-field-block"),r=i.data("level");t.updateAttributes(),$(e.target).prop("checked")?t.renderAttributes(r,o):i.children(".js-attribute-section-block").find(".js-field-block[data-parent-id="+o+"]").remove(),t.renderKworksAndOrders()})),this.block.on("click","."+this.classes.linkShowImages,(function(){t.showBlockImages()})),this.block.on("click","."+this.classes.linkShowVideos,(function(){t.showBlockVideos()}))}},{key:"kworkChange",value:function(){var t=this,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.updateKwork(),this.hideError(this.block.find("."+this.classes.kworkError));var o=this.portfolio.kwork_id,i=this.kworksList[parseInt(o)];if(e&&(o?this.getOrders(o,(function(e){t.renderOrders([],null,e.hasOrders)})):this.getKworks((function(e){t.renderOrders([],null,e.hasOrders)}))),i){var r=null;this.portfolio.category_id=i.category,$.each(this.additionalData.categories,(function(e,o){if(o.CATID==t.portfolio.category_id)return r=o.parent,!1})),this.renderParentCategories(r),this.renderCategories(this.portfolio.category_id),this.portfolio.attributes_ids=i.attributesIds,this.block.find("."+this.classes.attributes).html(""),this.renderAttributes(null)}}},{key:"orderChange",value:function(){var t=this.block.find("."+this.classes.selectKwork);this.updateOrder();var e="null";parseInt(this.portfolio.order_id)&&(e=this.ordersList[parseInt(this.portfolio.order_id)].PID),t.val(e),t.trigger("chosen:updated"),this.kworkChange(!1)}},{key:"renderKworksAndOrders",value:function(){var t=this;this.getKworks((function(e){t.renderKworks(e.kworks),t.renderOrders([],null,e.hasOrders)}))}},{key:"updateContent",value:function(){var e,o=this;this.clearExampleCardPreview(),this.generateExampleCardCnt(),this.block.find(".js-modal-title").text(this.portfolio&&this.portfolio.id?t("Редактировать работу в Портфолио"):t("Добавить работу в Портфолио")),this.block.find('input[name="title"]').val(he.decode(this.portfolio.title)),this.setExampleCardName(),this.sortableContainer.loadItems(this.portfolio.images),this.block.find("."+this.classes.videos).html(""),this.portfolio.videos.length&&$.each(this.portfolio.videos,(function(t,e){o.youtubeAdd(e)})),this.youtubeAdd(),this.youtubeVisibleRemoveBtn(),this.countCharacters(),this.defaultCoverField();var i=0,r=this.portfolio.cover.idPortfolioImage||-1,s=this.portfolio.images.find((function(t){return t.hash===o.portfolio.cover.hash||t.id==r}));if(s?(e=s.urlBig,i=s.id,this.showCoverTextNotLoad()):this.portfolio.cover&&this.portfolio.cover.type===this.COVER_IMAGE_TYPE_VIDEO?(e=this.portfolio.cover.urlBig,this.portfolio.cover.urlFromVideo=this.portfolio.cover.urlBig,this.showCoverTextNotLoad()):this.portfolio.cover&&this.portfolio.cover.urlBig?(this.portfolio.cover.urlDefault=this.portfolio.cover.urlBig,e=this.portfolio.cover.urlBig,this.showCoverTextLoad()):this.portfolio.images.length&&(e=this.portfolio.images[0].urlBig,i=this.portfolio.images[0].id,this.showCoverTextNotLoad()),e?(this.updateCoverMini(),this.updateCoverUrl(e),this.updateCoverIdPortfolioImage(i),this.updateCoverBlock()):this.hideCoverUpload(),this.titleInput.attr("placeholder",this.getPortfolioNumber()),this.page==this.PAGE_MY_PORTFOLIO){if(this.block.find("."+this.classes.attributes).html(""),this.fieldKworks.hide(),this.fieldOrders.hide(),this.additionalData&&!this.additionalData.canDeletePortfolio&&this.portfolio.id)this.fixedKworkId=this.portfolio.kwork_id,this.block.find(".js-can-delete-portfolio").hide();else{this.fixedKworkId=null,this.block.find(".js-can-delete-portfolio").show();var a=this.portfolio.category_id||null,l=null;$.each(this.additionalData.categories,(function(t,e){if(e.CATID==a)return l=e.parent,!1})),this.renderParentCategories(l),this.renderCategories(a),this.portfolio.category_id||this.updateCategory(),this.renderAttributes(),$.isEmptyObject(this.additionalData.kworks)||this.renderKworks(this.additionalData.kworks,this.portfolio.kwork_id),this.setExampleCardCategory()}$.isEmptyObject(this.additionalData.order)?this.renderOrders([],null,this.additionalData.hasOrders):this.renderOrders([this.additionalData.order],this.portfolio.order_id)}}},{key:"edit",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.portfolioItem=t,this.portfolio=$.extend(!0,{},t.data),this.additionalData=e,this._modalShow(),this.updateContent(),this.validateAll(),this.portfolioItem.blank=!1,this.updateSaveButton(),this.selectBlockVideosOrImages()}},{key:"setTitleErrors",value:function(e){var o="";o=e&&!0===e?this.titleInput.val():he.decode(this.portfolio.title),this.portfolioItem.backendErrors.title="",o.length>this.titleInput[0].maxLength&&(this.portfolioItem.backendErrors.title=t("Заголовок работы портфолио указан неверно, максимальная длина 40 символов"))}},{key:"updateTitle",value:function(){this.setTitleErrors(!0),this.portfolio.title=this.titleInput.val()}},{key:"updateCategory",value:function(){this.portfolio.category_id=this.block.find("."+this.classes.selectCategories).val()}},{key:"updateAttributes",value:function(){var t=this;this.portfolio.attributes_ids=[],this.block.find("."+this.classes.attributes).find(":checked").each((function(e,o){var i=$(o),r=i.closest(".attribute-list"),s=r.data("multiple-max-count"),a=r.find('input[type="checkbox"]:checked').size();s>0&&(a>=s?r.find('input[type="checkbox"]').not(":checked").prop("disabled",!0).parent().css("opacity","0.5"):r.find('input[type="checkbox"]').not(":checked").prop("disabled",!1).parent().css("opacity","1")),t.portfolio.attributes_ids.push(i.val())}))}},{key:"updateKwork",value:function(){this.portfolio.kwork_id=null,this.fixedKworkId?this.portfolio.kwork_id=this.fixedKworkId:this.fieldKworks.is(":visible")&&(this.portfolio.kwork_id=parseInt(this.block.find("."+this.classes.selectKwork).val())||null)}},{key:"updateOrder",value:function(){this.portfolio.order_id=null,this.fieldOrders.is(":visible")&&(this.portfolio.order_id=parseInt(this.block.find("."+this.classes.selectOrder).val())||null)}},{key:"updateCoverCrop",value:function(){this.portfolio.cover.crop=this.getCropperData()}},{key:"updateCoverUrl",value:function(t){this.portfolio.cover.url=t,this.portfolio.cover.urlBig=t}},{key:"updateCoverIdPortfolioImage",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.portfolio.cover.idPortfolioImage=t}},{key:"updateCoverHash",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.portfolio.cover.hash=t}},{key:"updateImages",value:function(){var t=[];$.each(this.sortableContainer.items,(function(e,o){t.push(o.data)})),this.portfolio.images=t}},{key:"updateVideos",value:function(){var t=[];this.block.find(".youtube-field input").each((function(e,o){var i=$(o).val().trim();i.length>0&&t.push(i)})),this.portfolio.videos=t}},{key:"setDefaultTitle",value:function(){this.portfolio.title||(this.portfolio.title=this.getPortfolioNumber())}},{key:"getPortfolioNumber",value:function(){return this.portfolio.workNum?t("Работа №")+this.portfolio.workNum:!$.isEmptyObject(this.additionalData)&&this.additionalData.workNum?t("Работа №")+this.additionalData.workNum:""}},{key:"selectBlockVideosOrImages",value:function(){var e='<span class="js-portfolio-images-link">'+t("изображения")+"</span>",o='<span class="js-portfolio-videos-link">'+t("видео")+"</span>";this.isTypeVideo()?(this.portfolioType="video",this.requiredPortfolioType.html(o),this.secondaryPortfolioType.html(e),this.showBlockVideos()):(this.portfolioType="photo",this.requiredPortfolioType.html(e),this.secondaryPortfolioType.html(o),this.validateVideos(),this.showBlockImages()),this.updateYoutubeCover()}},{key:"isTypeVideo",value:function(){var t,e=this.portfolio.category_id;return e&&$.each(this.additionalData.categories,(function(o,i){i.CATID==e&&(t=i.portfolio_type)})),(this.page==this.PAGE_KWORK||this.page==this.PAGE_ORDER)&&this.portfolioType==this.PORTFOLIO_TYPE_VIDEO||t==this.PORTFOLIO_TYPE_VIDEO}},{key:"showBlockImages",value:function(){this.fieldImages.show(),this.fieldVideos.hide(),this.block.find("."+this.classes.linkShowImages).removeClass("portfolio-images-videos-link"),this.block.find("."+this.classes.linkShowVideos).addClass("portfolio-images-videos-link"),this.block.find("."+this.classes.linkShowImages).parents("."+this.classes.field).find(".tooltipster").removeClass("hidden")}},{key:"showBlockVideos",value:function(){this.fieldImages.hide(),this.fieldVideos.show(),this.block.find("."+this.classes.linkShowImages).addClass("portfolio-images-videos-link"),this.block.find("."+this.classes.linkShowVideos).removeClass("portfolio-images-videos-link"),this.block.find("."+this.classes.linkShowImages).parents("."+this.classes.field).find(".tooltipster").addClass("hidden")}},{key:"concatErrors",value:function(t){var e=[];t in this.portfolioItem.backendErrors&&(e=e.concat(this.portfolioItem.backendErrors[t])),t in this.frontendErrors&&(e=e.concat(this.frontendErrors[t]));var o=[];return $.each(e,(function(t,e){-1==$.inArray(e,o)&&o.push(e)})),o.join("<br />")}},{key:"showError",value:function(t,e){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];t.html(e),(o||e.length>0)&&this.errorFields.push(t)}},{key:"hideError",value:function(t){t.html("");var e=this.errorFields.indexOf(t);void 0!==e&&this.errorFields.splice(e,1)}},{key:"validateTitle",value:function(){this.frontendErrors.title=[];var t=this.concatErrors("title");t.length>0?this.titleInput.addClass("input-error-portfolio"):this.titleInput.removeClass("input-error-portfolio"),this.showError(this.block.find("."+this.classes.titleError),t)}},{key:"validateCategory",value:function(){this.frontendErrors.category=[];var t=this.concatErrors("category");this.showError(this.block.find("."+this.classes.categoryError),t),this.portfolioItem.backendErrors.category=[]}},{key:"validateAttributes",value:function(){this.frontendErrors.attributes=[];var t=this.concatErrors("attributes");this.showError(this.block.find("."+this.classes.attributesError),t),this.portfolioItem.backendErrors.attributes=[]}},{key:"validateKwork",value:function(){this.frontendErrors.kwork=[];var t=this.concatErrors("kwork");this.showError(this.block.find("."+this.classes.kworkError),t)}},{key:"validateCover",value:function(){this.frontendErrors.cover=[],this.portfolioItem.blank||this.portfolio.cover.url||this.isTypeVideo()&&this.portfolio.cover.urlFromVideo||this.frontendErrors.cover.push(t("Необходимо загрузить обложку"));var e=this.concatErrors("cover");this.showError(this.block.find("."+this.classes.coverError),e)}},{key:"validateImages",value:function(){var e=this;this.frontendErrors.images=[],this.portfolioItem.blank||this.page!=this.PAGE_KWORK||this.portfolioType==this.PORTFOLIO_TYPE_PHOTO&&this.portfolio.images.length<1&&this.frontendErrors.images.push(t("Загрузите изображение"));var o=this.portfolioItem.backendErrors.image;o&&Object.keys(o).length>0&&("images"in this.portfolioItem.backendErrors||(this.portfolioItem.backendErrors.images=[]),$.each(this.sortableContainer.items,(function(t,i){i.hasError=t in o,i.updateErrorVisuals(),e.portfolioItem.backendErrors.images.push(o[t])})));var i=this.concatErrors("images");i.length>0&&this.showBlockImages(),this.showError(this.block.find("."+this.classes.imagesError),i),this.portfolioItem.backendErrors.images=[],this.portfolioItem.backendErrors.image=[]}},{key:"getErrors",value:function(){this.errorFields=[];var t=this.block.find("."+this.classes.videos).find(".youtube-field input.input-error-portfolio");t.length?this.errorFields.push(t):(this.errorFields=[],this.frontendErrors.videos=[])}},{key:"backendValidateVideos",value:function(t){var e=t.val().trim(),o=t.parent().find(".portfolio-error"),i=this;$.ajax({type:"POST",url:"/api/portfolio/youtubelinkvalidate?url="+e,data:{kwork_id:this.portfolio.kwork_id||null,portfolio_id:this.portfolio.id||null},success:function(e){e.success?(t.removeClass(i.classes.inputClassError),i.hasError=!1,o.text(""),i.youtubeRemoveEmptyFiels()):(t.addClass(i.classes.inputClassError),o.html(e.data),i.hasError=!0,i.frontendErrors.videos.push(""),i.youtubeRemoveEmptyFiels(!0))},error:function(t){},complete:function(){i.getErrors(),i.updateVideos(),i.updateYoutubeCover()}})}},{key:"validateVideos",value:function(e,o){if(!this.portfolioItem.blank){var i=0;if(this.block.find("."+this.classes.fieldYoutube+" input").each((function(t,e){$(e).val().trim().length>0&&i++})),o){var r=this.block.find("."+this.classes.fieldYoutube).index(o.parents(".youtube-field"));this._youtubeValidation(o,r,e)?this.backendValidateVideos(o):this.youtubeRemoveEmptyFiels()}(this.page==this.PAGE_KWORK||this.PAGE_MY_PORTFOLIO)&&this.portfolioType==this.PORTFOLIO_TYPE_VIDEO&&i<1&&(this.block.find("."+this.classes.videos).find(".youtube-field:first-child input").parent().find(".portfolio-error").text(t("Необходимо указать ссылку на видео")),this.block.find("."+this.classes.videos).find(".youtube-field:first-child input").addClass("input-error-portfolio"),this.youtubeRemoveEmptyFiels()),(this.page==this.PAGE_KWORK||this.PAGE_MY_PORTFOLIO)&&this.portfolioType==this.PORTFOLIO_TYPE_PHOTO&&i<1&&(this.block.find("."+this.classes.videos).find(".youtube-field:first-child input").parent().find(".portfolio-error").text(""),this.block.find("."+this.classes.videos).find(".youtube-field:first-child input").removeClass("input-error-portfolio"))}this.getErrors(),this.portfolioItem.backendErrors.videos=[],this.portfolioItem.backendErrors.video={}}},{key:"updateAll",value:function(){this.updateTitle(),this.page==this.PAGE_MY_PORTFOLIO&&(this.updateCategory(),this.updateAttributes(),this.updateKwork(),this.updateOrder()),this.updateCoverCrop(),this.updateImages(),this.updateVideos()}},{key:"moveToError",value:function(){var t=this.errorFields[0];if(t){var e=this.block.scrollTop()+t.offset().top-this.block.offset().top-$(window).height()/2;this.block.animate({scrollTop:e},200)}}},{key:"save",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.updateAll(),this.getErrors();var o=!1,i=!1;if(!1===e){this.validateAll(!0);var r=!1;if($.each(this.errorFields,(function(t,e){e.length>0&&(e.selector.includes("youtube-field")?i=!0:o=!0,r=!0)})),r)return"photo"==this.portfolioType?o?this.showBlockImages():this.showBlockVideos():"video"==this.portfolioType&&(i?this.showBlockVideos():this.showBlockImages()),void this.moveToError()}this.errorFields.length||(this.portfolioItem.html.removeClass("error"),this.portfolioItem.html.find(".draggable-block_error").text(""));var s=this.getImgCropper();if(s&&(this.portfolio.cover.url=s),this.portfolio.cover.type!=this.COVER_IMAGE_TYPE_VIDEO&&delete this.portfolio.cover.urlFromVideo,this.page===this.PAGE_KWORK)this.saveSucess(e);else{this.setDefaultTitle(),this._lockSaveBtn();var a=this.portfolioItem.getData(this.portfolio);this.orderId&&(a.order_id=this.orderId);var l=new FormData;l.append("portfolio",JSON.stringify(a)),this.xhr&&this.xhr.abort(),this.xhr=$.ajax({url:"/portfolio/add",data:l,async:!0,contentType:!1,processData:!1,type:"POST",complete:function(e,o){var i={};try{i=JSON.parse(e.responseText)}catch(t){}if("success"in i&&1==i.success){if(1==t.reloadAfterSave)return void(window.location=window.location.href);t.page!=t.PAGE_ORDER||t.portfolio.id?t.page==t.PAGE_MY_PORTFOLIO?(t.updatePortfolioCard(i.data.id),t.saveSucess()):t.saveSucess():window.location=window.location.href}else t.portfolioItem.applyErrors(i.data),t.validateAll(),t.moveToError(),t._unlockSaveBtn()}})}this.additionalData&&this.additionalData.workNum&&this.additionalData.workNum++}},{key:"saveSucess",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.portfolio.draftHash||this.portfolio.id||(this.portfolio.draftHash=Date.now()),!0===t&&!this.portfolio.title&&!this.portfolio.images.length&&!this.portfolio.videos.length&&null===this.portfolio.cover.hash)return!1;!0!==t||this.portfolio.title?this.setDefaultTitle():this.portfolio.title=this.titleInput.attr("placeholder"),$.extend(this.portfolioItem.data,this.portfolio),this.onSave(),!1===t&&(this.confirmAtClose=!1,this._modalHide(),this._unlockSaveBtn(),this.destroyCropper())}},{key:"countCharacters",value:function(t){var e=this;t?this._countCharacters(t):$(this.block).find("."+this.classes.fieldCounter).each((function(t,o){e._countCharacters($(o))}))}},{key:"youtubeAdd",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=this.block.find("."+this.classes.videos).find("input:focus");if(o.length){var i=o.val();if(0==Youtube.isUrl(i))return}var r=this.block.find("."+this.classes.videos),s=this.block.find("."+this.classes.videos).find("."+this.classes.fieldYoutube),a=r.find("."+this.classes.fieldYoutube+" input").filter((function(){return""===this.value}));if(s.length>=this.MAX_YOUTUBE||a.length>0)return!1;r.append('\n\t\t\t<div class="'+this.classes.fieldYoutube+'">\n\t\t\t\t<input type="text"\n\t\t\t\t\t class="input styled-input f14 wMax"\'\n\t\t\t\t\t placeholder="'+t("Ссылка на видео с YouTube")+'"\n\t\t\t\t\t value="'+e+'" />\n\t\t\t\t<div class="js-youtube-remove youtube-remove"><i class="kwork-icon icon-close"></i></div>\n\t\t\t\t<div class="portfolio-error"></div>\n\t\t\t</div>\n\t\t'),this.youtubeVisibleRemoveBtn()}},{key:"youtubeRemove",value:function(t){if(!t)return!1;this.block.find("."+this.classes.fieldYoutube).length>1?(t.closest("."+this.classes.fieldYoutube).remove(),this.youtubeAdd()):(t.removeClass(this.classes.inputClassError),t.val(""),t.parent().find(".portfolio-error").text("")),this.youtubeVisibleRemoveBtn(),this.updateYoutubeCover()}},{key:"youtubeEvents",value:function(t){this.youtubeRemoveDuplicate(t),this.youtubeVisibleRemoveBtn(),this.validateVideos(null,t),this.updateYoutubeCover()}},{key:"updateYoutubeCover",value:function(){if(!this.portfolio.images.length&&!this.portfolio.cover.urlDefault||this.portfolio.cover.urlFromVideo)if(delete this.portfolio.cover.urlFromVideo,this.isTypeVideo()&&!this.frontendErrors.videos.length){var t=this.block.find("."+this.classes.fieldYoutube+" input");if(1!==t.length||t.val()){var e=$(t[0]).val(),o=Youtube.thumb(e,"max");this.setYoutubeThumb(o)}else this.selectRandomCover()}else this.selectRandomCover()}},{key:"setYoutubeThumb",value:function(t){var e=this,o=new Image;o.onload=function(){var t;o.width>e.MIN_WIDTH_CROP_BOX&&o.height>e.MIN_HEIGHT_CROP_BOX&&(t=o.src),e.showYoutubeCoverThumb(t)},o.src=t}},{key:"showYoutubeCoverThumb",value:function(t){t?(this.portfolio.cover.urlFromVideo=t,this.portfolioItem.backendErrors.cover=[],this.updateCoverMini(),this.portfolio.cover.urlDefault||(this.updateCoverUrl(t),this.updateCoverIdPortfolioImage(),this.updateCoverBlock(),this.portfolio.cover.type=this.COVER_IMAGE_TYPE_VIDEO)):this.selectRandomCover()}},{key:"youtubeRemoveDuplicate",value:function(t){if(!t||0==t.length)return!1;var e=t.val(),o=[];if(""==e)return null;this.block.find("."+this.classes.fieldYoutube+" input").not(t).each((function(t,e){var i=$(e).val();""!=i&&o.push(i)})),o.length>0&&$.inArray(e,o)>=0&&this.youtubeRemove(t)}},{key:"youtubeVisibleRemoveBtn",value:function(){var t=this;$("."+this.classes.videos+" ."+this.classes.fieldYoutube+" input").each((function(e,o){var i=$(o).val(),r=$(o).closest("."+t.classes.fieldYoutube).find("."+t.classes.youtubeRemove);i.length<=0?r.hide():r.show()}))}},{key:"youtubeRemoveEmptyFiels",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=$("."+this.classes.videos+" ."+this.classes.fieldYoutube+" input");o.each((function(e,o){var i=$(o),r=i.val(),s=i.closest("."+t.classes.fieldYoutube),a=i.is(":focus");0!=r.length||a||s.remove()})),e||this.youtubeAdd()}},{key:"_countCharacters",value:function(e){var o=e.closest("."+this.classes.field),i=e.data("max"),r="",s="";if(e.is("input"))s=e.val();else{if(!e.is("textarea"))return!1;s=e.text()}if(i){i=parseInt(i);var a=0^s.replace(/&nbsp;/gi," ").replace(/\s\s+/g," ").length,l=o.find("."+this.classes.fieldCounterHint);a>0&&(r=t("{{0}} из",[a])+" "),r+=t("{{0}} максимум",[i]),l.text(r),a>i?l.addClass("color-red"):l.removeClass("color-red")}}},{key:"_youtubeValidation",value:function(e,o,i){if(e){if(window.Youtube){var r=e.val().trim(),s=e.parent().find(".portfolio-error");if(!r.length>0)return e.removeClass(this.classes.inputClassError),this.frontendErrors.videos=[],void s.text("");var a=!1;return this.checkVideoUrl&&(a=!this.checkVideoUrl(r,o)),o in(this.portfolioItem.backendErrors.video||{})?(e.addClass(this.classes.inputClassError),s.html(this.portfolioItem.backendErrors.video[o]),!1):a?(e.addClass(this.classes.inputClassError),s.text(t("Данное видео уже загружено в рамках другой работы")),!1):!(r&&!Youtube.isUrl(r)&&(e.addClass(this.classes.inputClassError),s.text(t("Указанная ссылка не является ссылкой на видео с youtube.com")),1))}console.error('Youtube is not defined ("youtube-thumbnail.js")')}}},{key:"validateAll",value:function(t){this.validateTitle(),this.validateCategory(),this.validateAttributes(),this.validateKwork(),this.validateCover(),this.validateImages(),this.validateVideos(t)}},{key:"updateSaveButton",value:function(){this.isFormValid()?this._unlockSaveBtn():this._lockSaveBtn()}},{key:"isFormValid",value:function(){return!!this.sortableContainer.isReady()}},{key:"_lockSaveBtn",value:function(){this.block.find("."+this.classes.btnSave).attr("disabled","disabled").addClass(this.classes.btnDisabled)}},{key:"_unlockSaveBtn",value:function(){this.block.find("."+this.classes.btnSave).removeAttr("disabled").removeClass(this.classes.btnDisabled)}},{key:"_modalShow",value:function(){this.confirmAtClose=!0,this.setTitleErrors(),this.block.modal("show")}},{key:"_modalHide",value:function(){this.confirmAtClose=!1,this.block.modal("hide"),this.destroyCropper(),this.clearCover()}},{key:"_cropImgTpl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return'<div class="cover-image__cropper"><img src="'+t+'"></div>'}},{key:"renderParentCategories",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=this.block.find("."+this.classes.selectParentCategories);o.html("");var i=this.additionalData.parentCategories;o.append('<option disabled="" selected="selected" hidden="">'+t("Выберите категорию")+"</option>"),$.each(i,(function(t,e){o.append('<option value="'+e.CATID+'" data-parent="'+e.parent+'">'+e.name+"</option>")})),this.selectOption(o,e),o.trigger("chosen:updated")}},{key:"renderCategories",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this.block.find("."+this.classes.selectCategories),o=this.block.find("."+this.classes.selectParentCategories).find("option:selected").val();e.html("");var i=this.additionalData.categories,r=0;$.each(i,(function(t,i){if(i.parent!=o)return!0;e.append('<option value="'+i.CATID+'" data-parent="'+i.parent+'">'+i.name+"</option>"),r++})),r<1?e.parent().addClass("empty-list"):e.parent().removeClass("empty-list"),this.selectOption(e,t),e.trigger("chosen:updated")}},{key:"renderKworks",value:function(){var e=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.block.find("."+this.classes.selectKwork);r.html('<option value="null">'+t("Не выбрано")+"</option>"),$.isEmptyObject(o)?this.fieldKworks.hide():(this.fieldKworks.show(),$.each(o,(function(t,o){e.kworksList[parseInt(o.PID)]=o,r.append('<option value="'+o.PID+'">'+o.gtitle+"</option>")}))),this.selectOption(r,i),r.trigger("chosen:updated")}},{key:"renderOrders",value:function(){var e=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=this.block.find("."+this.classes.selectOrder);s?this.block.find("."+this.classes.selectOrder).parent().addClass("loaded"):this.block.find("."+this.classes.selectOrder).parent().removeClass("loaded"),a.html('<option value="null">'+t("Не выбрано")+"</option>"),!this.additionalData.order||!this.additionalData.order.OID||this.portfolio.kwork_id&&this.additionalData.order.PID!=this.portfolio.kwork_id||o.unshift(this.additionalData.order),$.isEmptyObject(o)||(r=!0),r?(this.fieldOrders.show(),$.isEmptyObject(o)||$.each(o,(function(o,i){e.ordersList[parseInt(i.OID)]=i;var r=new Date(i.date_done).toLocaleString()||null;r=r?t("принят:")+" "+r:"";var s=i.payerUsername||null;s=s?t("покупатель:")+" "+s:"";var l=r&&s?"; ":"",n=i.kwork_title+" ("+r+l+s+")";a.append("<option"+(i.OID==e.portfolio.order_id?" selected":"")+' value="'+i.OID+'">'+n+"</option>")}))):this.fieldOrders.hide(),this.selectOption(a,i),a.trigger("chosen:updated")}},{key:"selectOption",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!t||!e)return!1;t.find("option").prop("selected",!1).removeAttr("selected"),t.find('option[value="'+e+'"]').prop("selected",!0)}},{key:"getOrders",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1?arguments[1]:void 0,i=this.block.find("."+this.classes.selectOrder);this.startSelectLoader(i),this.getOrdersXhr&&this.getOrdersXhr.abort(),this.getOrdersXhr=$.ajax({type:"POST",url:"/portfolio/load_form_orders",data:{kworkId:e},dataType:"json",success:function(e){t.stopSelectLoader(i),e.success&&o&&o(e.data)}})}},{key:"getFullOrders",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1?arguments[1]:void 0,i=this.block.find("."+this.classes.selectOrder);this.startSelectLoader(i),this.getOrdersXhr&&this.getOrdersXhr.abort(),this.getOrdersXhr=$.ajax({type:"POST",url:"/portfolio/load_form_orders_full",data:{kworkId:e},dataType:"json",success:function(e){t.stopSelectLoader(i),e.success&&o&&o(e.data)}})}},{key:"getKworks",value:function(t){var e=this;this.kworksOrdersXhr&&this.kworksOrdersXhr.abort();var o=this.portfolio.category_id,i=this.portfolio.attributes_ids;if(!o)return!1;var r=this.block.find("."+this.classes.selectKwork),s=this.block.find("."+this.classes.selectOrder);this.startSelectLoader(r),this.startSelectLoader(s),this.kworksOrdersXhr=$.ajax({type:"POST",url:"/portfolio/load_form_kworks",data:{categoryId:o,attributesId:i},dataType:"json",success:function(o){e.stopSelectLoader(r),e.stopSelectLoader(s),o.success&&t&&t(o.data)}})}},{key:"startSelectLoader",value:function(e){this.stopSelectLoader(e);var o=e.parent();o.addClass("empty-list"),o.append('<div class="js-loader select-loader"><img src="'+Utils.cdnImageUrl("/ajax-loader.gif")+'">'+t("Загрузка...")+"</div>")}},{key:"stopSelectLoader",value:function(t){var e=t.parent();e.find(".js-loader").remove(),e.removeClass("empty-list")}},{key:"requestAttributes",value:function(t,e){var o=this;if(t.length<=0)e();else{var i,r=this.block.find("."+this.classes.attributes+" input");if($(r).each((function(){var e=parseInt($(this).attr("value")),o=t.indexOf(e);if(-1!=o)return i=t.splice(o,1)[0],!1})),i||(i=t.shift()),i||this.portfolio.category_id){var s={categoryId:this.portfolio.category_id,lang:window.lang,onlyPortfolioAllowed:1};i&&(s.attributeId=i),this.attrXhr&&this.attrXhr.abort(),this.attrXhr=$.ajax({type:"GET",url:"/api/attribute/loadclassification",data:s,dataType:"json",success:function(r){if(r.success){var s=o.block.find("."+o.classes.attributes+" input[value="+i+"]").closest(".js-field-block").children(".js-attribute-section-block");s.length||(s=o.block.find("."+o.classes.attributes)),s.append(r.html),o.requestAttributes(t,e)}}})}else e()}}},{key:"renderAttributes",value:function(t,e){var o,i=this;this.attributesLoaded=!1,o=t?[this.portfolio.attributes_ids[this.portfolio.attributes_ids.length-1]]:[null].concat(this.portfolio.attributes_ids||[]),e&&(o=[e]),this.requestAttributes(o,(function(){i.block.find(".js-field-block").each((function(t,e){$(e).attr("data-level",t+1)})),i.portfolio.attributes_ids&&$.each(i.portfolio.attributes_ids,(function(t,e){i.block.find('.js-field-block input[value="'+e+'"]').prop("checked",!0)})),i.updateAttributes(),i.validateAttributes(),i.attributesLoaded=!0}))}},{key:"getObjectChanges",value:function(t,e){var o={};for(var i in e)if(!t||t[i]!=e[i])if("object"==a(e[i])){var r=this.getObjectChanges(t[i],e[i]);$.isEmptyObject(r)||(o[i]=r)}else o[i]=e[i];return o}},{key:"sortInArray",value:function(t){var e={};for(var o in t){var i=Object.prototype.toString.call(t[o]);e[o]="[object Array]"===i?t[o].sort():"[object Object]"===i?this.sortInArray(t[o]):t[o]}return e}},{key:"isChangedPortfolio",value:function(){var t=Object.assign({},this.portfolioItem.data),e=Object.assign({},this.portfolio);t.coverHash=t.cover.hash,e.coverHash=e.cover.hash,delete t.cover,delete e.cover,t=this.sortInArray(t),e=this.sortInArray(e);var o=this.getObjectChanges(t,e);return!$.isEmptyObject(o)}},{key:"allowableRangeForCrop",value:function(t,e){if(t&&e)return Math.abs(t-e)<1e-4}},{key:"updatePortfolioCard",value:function(t){var e=this;if(this.page!=this.PAGE_MY_PORTFOLIO)return!1;var o=$(".portfolio-list-collage"),i="";this.portfolio.id?$.ajax({type:"GET",url:"/portfolio_card/"+t,dataType:"html",success:function(r){i=r,e.portfolio.id?o.find('.portfolio-card-collage[data-id="'+t+'"]').replaceWith(i):(o.prepend(i),o.find(".portfolio-card-collage").last().remove())},error:function(t){}}):window.location=window.location.href}},{key:"generateExampleCardCnt",value:function(){var t=Math.round(99.5+900*Math.random()),e=Math.round(.6*t),o=Math.round(.25*e);this.exampleCardCntViews.text(t),this.exampleCardCntLikes.text(e),this.exampleCardCntComments.text(o)}},{key:"setExampleCardName",value:function(){var t=this.exampleCardName.data("isEmpty"),e=this.portfolio.title||this.getPortfolioNumber()||t;this.exampleCardName.html(e)}},{key:"setExampleCardCategory",value:function(){var t=this.exampleCardCategory.data("isEmpty"),e=this.portfolio.category_id,o="";e&&$.each(this.additionalData.categories,(function(t,i){i.CATID==e&&(o=i.name)})),this.exampleCardCategory.text(o||t)}},{key:"clearExampleCardPreview",value:function(){this.exampleCardThumbnail.find("img").remove(),this.exampleCardThumbnail.css({overflow:"hidden"})}}])&&l(o.prototype,i),n&&l(o,n),e}()},50:function(t,e,o){"use strict";o.d(e,"a",(function(){return a}));var i=o(22),r=o(19);function s(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=function(){function t(e){var o=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.draggedBlock=null,this.stageOffset=null,this.stageWidth=0,this.stageHeight=0,this.containerWidth=0,this.containerHeight=0,this.containerRowSize=3,this.blockDragLeft=0,this.blockDragTop=0,this.stageBlock=$(e),this.draggableBlocks=this.stageBlock.find(".draggable-blocks"),this.placeholders=this.stageBlock.find(".placeholders"),this.errorBlock=this.stageBlock.find(".portfolio-error"),this.type=this.stageBlock.data("type"),this.maxCount=this.stageBlock.data("maxCount")||9,this.sortable="unsortable"!=this.stageBlock.data("sortable"),this.items=[],this.additionalData={};var r=this.stageBlock.find(".data-additional");r.length&&(this.additionalData=JSON.parse(r.val())),"portfolios"==this.type&&(this.modal=new i.a,this.modal.onSave=function(t){o.itemSave(o.modal.portfolioItem),o.modal.portfolioItem.hasError=!1,o.modal.portfolioItem.updateErrorVisuals(),$.each(o.items,(function(t,e){if(e.hasError)return!1;o.errorBlock.text("")}))},this.modal.getImagesHashes=function(t){return o.getImagesHashes(t)},this.modal.getCoverHashes=function(t){return o.getCoverHashes(t)},this.modal.checkCoverHash=function(t){return o.checkCoverHash(t)},this.modal.checkImageHash=function(t){return o.checkImageHash(t)},this.modal.checkVideoUrl=function(t,e){return o.checkVideoUrl(t,e)},this.loadItems(window.portfolios)),this.stageBlock.find(".create-block").on("click",(function(){o.createItemDialogue()})),$(document).mousemove((function(t){return o.dragMove(t)})),$(document).mouseup((function(t){o.dragStop(t)})),$(window).on("resize",(function(){o.updateOffsets(),o.updateAllBlockCoordinates()}))}var e,o,a;return e=t,(o=[{key:"updateAddBlock",value:function(){return this.items.length>=this.maxCount?(this.stageBlock.find(".create-block").hide(),0):(this.stageBlock.find(".create-block").show(),1)}},{key:"updatePlaceholders",value:function(){for(var t=this.updateAddBlock(),e="",o=0,i=this.items.length+t;o<i;o++)e+='<div class="placeholder"><div class="image"></div></div>';this.placeholders.html(e)}},{key:"createItemDialogue",value:function(){var t=this,e=this.createItem();"portfolios"==this.type?this.modal.edit(e,this.additionalData):(e.onLoad=function(){t.itemSave(e)},e.fileUploader.upload())}},{key:"editItem",value:function(t){"portfolios"==this.type?this.modal.edit(t,this.additionalData):this.uploaderBlock.trigger("click")}},{key:"loadItems",value:function(t){var e=this;this.items=[],this.draggableBlocks.find(".item").remove(),$.each(t,(function(t,o){var i=e.createItem(o);e.items.push(i),e.draggableBlocks.append(i.html)})),this.updatePlaceholders(),this.updateOffsets(),this.updateAllBlockCoordinates()}},{key:"itemSave",value:function(t){t.updateImage(),-1==this.items.indexOf(t)&&(this.items.push(t),this.draggableBlocks.append(t.html),this.updatePlaceholders(),this.updateOffsets(),this.updateAllBlockCoordinates())}},{key:"createItem",value:function(t){var e=this,o=null;return"portfolios"==this.type?o=new r.b(t):"images"==this.type&&(o=new r.a(t)),o.onLoadStart=function(){e.stageBlock.find(".portfolio-error").html("")},o.onError=function(t){e.stageBlock.find(".portfolio-error").html(t)},o.onDragStart=function(t){e.dragStart(t,o)},o.onEdit=function(){e.editItem(o)},o.onDelete=function(){e.deleteItem(o),"images"==e.type&&e.onDelete(o)},o.onChangeState=function(){e.onChangeState()},o.onSuccess=function(){e.onSuccess(o)},o}},{key:"deleteItem",value:function(t){t.html.remove(),this.items.splice(this.items.indexOf(t),1),this.stageBlock.find(".placeholder:last-child").remove(),this.updatePlaceholders(),this.updateOffsets(),this.updateAllBlockCoordinates()}},{key:"updateOffsets",value:function(){this.stageOffset=this.stageBlock.offset(),this.stageWidth=this.stageBlock.outerWidth(),this.stageHeight=this.stageBlock.outerHeight();var t=this.stageBlock.find(".placeholder");this.containerWidth=t.outerWidth(),this.containerHeight=t.outerHeight();var e=-1;if(0==this.sortable);else for(var o=this.stageWidth+30;o>0;o-=205)e++;this.stageBlock.attr("data-cols",e),this.containerRowSize=e}},{key:"getPositionByCoords",value:function(t,e){var o=Math.round(e/this.containerHeight),i=Math.round(t/(this.stageWidth/this.containerRowSize)),r=o*this.containerRowSize+i;return r>=this.items.length&&(r=this.items.length-1),r}},{key:"updateAllBlockCoordinates",value:function(){var t=this;$.each(this.items,(function(e,o){t.updateBlockCoordinates(o.html,e)})),this.updateBlockCoordinates(this.stageBlock.find(".create-block"),this.items.length)}},{key:"updateBlockCoordinates",value:function(t,e){var o=this.stageBlock.find(".placeholder:nth-child("+(e+1)+")");if(!(o.length<1)){var i=o.offset(),r=i.top-this.stageOffset.top,s=i.left-this.stageOffset.left;t.css({top:r,left:s})}}},{key:"dragStart",value:function(t,e){if(this.sortable&&1==t.which){this.updateOffsets(),e.html.addClass("moved");var o=e.html.offset();return this.blockDragLeft=t.pageX-o.left,this.blockDragTop=t.pageY-o.top,this.draggedBlock=e,!1}}},{key:"dragStop",value:function(t){this.draggedBlock&&(this.draggedBlock.html.removeClass("moved"),this.updateAllBlockCoordinates(),this.draggedBlock=null)}},{key:"dragMove",value:function(t){if(this.draggedBlock){var e=t.pageY-this.stageOffset.top-this.blockDragTop,o=t.pageX-this.stageOffset.left-this.blockDragLeft,i=this.stageWidth-this.containerWidth,r=this.stageHeight-this.containerHeight;o<0?o=0:o>i&&(o=i),e<0?e=0:e>r&&(e=r);var s=this.items.indexOf(this.draggedBlock),a=this.getPositionByCoords(o,e);return a!=s&&this.moveElement(this.items,s,a),this.updateAllBlockCoordinates(),this.draggedBlock.html.css({left:o+"px",top:e+"px"}),!1}}},{key:"moveElement",value:function(t,e,o){if(o>=t.length)for(var i=o-t.length+1;i--;)t.push(void 0);t.splice(o,0,t.splice(e,1)[0])}},{key:"getData",value:function(){var t=[];return $.each(this.items,(function(e,o){t.push(o.getData())})),t}},{key:"isReady",value:function(){var t=!0;return $.each(this.items,(function(e,o){if(o.uploadableBase64)return t=!1,!1})),t}},{key:"applyErrors",value:function(t){var e={};$.each(t,(function(t,o){e[parseInt(o.position)]=o.errors})),$.each(this.items,(function(t,o){var i=[];t in e&&(i=e[t]),o.applyErrors(i)}))}},{key:"checkCoverHash",value:function(t){var e=this.getCoverHashes();return-1==$.inArray(t,e)}},{key:"checkImageHash",value:function(t){var e=this.getImagesHashes();return-1==$.inArray(t,e)}},{key:"checkVideoUrl",value:function(t,e){var o=this.getVideoUrls(e);return-1==$.inArray(t,o)}},{key:"getCoverHashes",value:function(){var t=[],e=this.modal.portfolioItem;return $.each(this.items,(function(o,i){if(i==e)return!0;i.data.cover.hash&&t.push(i.data.cover.hash)})),t}},{key:"getImagesHashes",value:function(){var t=[],e=this.modal.portfolioItem,o=this.modal.portfolio?this.modal.portfolio.images:[];return $.each(this.items,(function(o,i){if(i==e)return!0;$.each(i.data.images,(function(e,o){t.push(o.hash)}))})),$.each(o,(function(e,o){t.push(o.hash)})),t}},{key:"getVideoUrls",value:function(t){var e=[],o=this.modal.portfolioItem,i=this.modal.portfolio.videos;return $.each(this.items,(function(t,i){if(i==o)return!0;$.each(i.data.videos,(function(t,o){e.push(o)}))})),$.each(i,(function(o,i){if(o==t)return!0;e.push(i)})),window.ordersPortfolioVideos&&$.each(window.ordersPortfolioVideos,(function(t,o){e.push(o)})),e}}])&&s(e.prototype,o),a&&s(e,a),t}()},60:function(e,o,i){"use strict";i.r(o);var r=i(22),s=i(19);function a(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var l=function(){function e(){var t=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.body=$("body"),this.modal=new r.a,this.modal.onSave=function(e){t.savePortfolio(t.modal.portfolioItem)},this.modal.getImagesHashes=function(e){return t.getImagesHashes(e)},this.modal.getCoverHashes=function(e){return t.getCoverHashes(e)},this.modal.checkCoverHash=function(e){return t.checkCoverHash(e)},this.modal.checkImageHash=function(e){return t.checkImageHash(e)},this.modal.checkVideoUrl=function(e,o){return t.checkVideoUrl(e,o)},this.events()}var o,i,l;return o=e,(i=[{key:"events",value:function(){var t=this;this.body.on("click",".portfolio-card .js-edit-portfolio, .portfolio-card-collage .js-edit-portfolio",(function(e){var o=$(e.target).closest(".portfolio-card, .portfolio-card-collage").data("id");t.openPortfolioModal(o)})),this.body.on("click",".portfolio-card .js-delete-portfolio, .portfolio-card-collage .js-delete-portfolio",(function(e){var o=$(e.target).closest(".portfolio-card, .portfolio-card-collage").data("id");t.deletePortfolioCardModal(e.target,o)})),this.body.on("click",".portfolio-card-delete-modal .js-portfolio-card-delete-cancel",(function(e){t.deletePortfolioCardModalClose()})),this.body.on("click",".js-portfolio-card-delete-confirm",(function(e){t.deletePortfolioCardModalConfirm()})),this.body.on("click",".portfolio-large .js-edit-portfolio",(function(e){portfolioCard.close(),setTimeout((function(){var o=$(e.target).closest(".portfolio-large").data("portfolioId");t.openPortfolioModal(o)}),100)})),this.body.on("click",".js-new-portfolio",(function(e){t.openPortfolioModal(null)}))}},{key:"openPortfolioModal",value:function(t){var e=this;this.getPortfolioData(t,(function(t){var o=new s.b(t.portfolio);e.modal.edit(o,t.additional)}))}},{key:"deletePortfolioCardModal",value:function(e,o){var i=this;this.startLoader(),$.ajax({type:"GET",url:"/portfolio/can_delete/"+o,dataType:"json",success:function(r){if(i.stopLoader(),r.success){var s;if(r.data.canDeletePortfolio)(s=$(".js-portfolio-card-can-delete-modal")).find(".js-portfolio-card-delete-confirm").attr("data-id",o);else{s=$(".js-portfolio-card-cant-delete-modal");var a="",l=$(e).data("name"),n=$(e).data("url"),d=r.data.neededPortfolioCount?r.data.neededPortfolioCount:"";d&&(d=" ("+t("минимум")+" "+d+")"),a+=l&&""!=l?"<p>"+t("Удалить работу нельзя, поскольку в кворке «{{0}}» не будет нужного количества работ в портфолио",[l])+d+".</p>":"<p>"+t("Удалить работу нельзя, поскольку в кворке не будет нужного количества работ в портфолио")+d+".</p>",a+='<p class="mt10">'+t('<a href="{{0}}">Добавьте в кворк</a> новую работу, чтобы удалить данную.',[n])+"</p>",s.find(".modal-body").html(a)}s.modal("show")}}})}},{key:"deletePortfolioCardModalClose",value:function(){$(".portfolio-card-delete-modal").modal("hide")}},{key:"deletePortfolioCardModalConfirm",value:function(){if("my-portfolios"===window.portfolioList.modal.page){var t=new FormData,e=$(".js-portfolio-card-delete-confirm").attr("data-id");t.append("portfolio_id",e),$.ajax({url:"/portfolio/delete",data:t,async:!0,contentType:!1,processData:!1,type:"POST",complete:function(t,o){var i={};try{i=JSON.parse(t.responseText)}catch(t){}"success"in i&&!0===i.success&&($('.js-portfolio-card[data-id="'+e+'"]').remove(),$(".header_top").append('<div class="fox_success" style="display:none"><div class="text-center"><p>Работа успешно удалена</p></div></div>'),$(".fox_success").slideDown(300),setTimeout((function(){$(".fox_success").slideUp(300),setTimeout((function(){$(".fox_success").remove()}),400)}),2e3))}})}this.deletePortfolioCardModalClose()}},{key:"checkCoverHash",value:function(t){var e=this.getCoverHashes();return-1==$.inArray(t,e)}},{key:"checkImageHash",value:function(t){var e=this.getImagesHashes();return-1==$.inArray(t,e)}},{key:"checkVideoUrl",value:function(t,e){var o=this.getVideoUrls(e);return-1==$.inArray(t,o)}},{key:"getCoverHashes",value:function(){return this.modal.additionalData.coverHashes||[]}},{key:"getImagesHashes",value:function(){var t=[];return $.each(this.modal.portfolio.images,(function(e,o){t.push(o.hash)})),t=t.concat(this.modal.additionalData.imagesHashes||[])}},{key:"getVideoUrls",value:function(t){var e=[];return $.each(this.modal.portfolio.videos,(function(o,i){if(o==t)return!0;e.push(i)})),e=e.concat(this.modal.additionalData.anotherVideos||[])}},{key:"savePortfolio",value:function(t){return this.modal.coverHashes}},{key:"getPortfolioData",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1?arguments[1]:void 0;this.startLoader(),$.ajax({type:"POST",url:"/portfolio/get_popup",data:{portfolioId:e},dataType:"json",success:function(e){t.stopLoader(),e.success&&o&&o(e.data)}})}},{key:"startLoader",value:function(){lockBodyForPopup(),this.body.append('<div class="portfolio-loader-wrapper"> <div class="portfolio-loader portfolio-loader-white"><div class="ispinner ispinner--gray ispinner--animating ispinner--large"><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div><div class="ispinner__blade"></div></div></div></div>')}},{key:"stopLoader",value:function(){unlockBodyForPopup(),this.body.find(".portfolio-loader-wrapper").remove()}}])&&a(o.prototype,i),l&&a(o,l),e}();$(document).ready((function(){window.portfolioList=new l}))},98:function(t,e,o){t.exports=o(99)},99:function(t,e,o){o(60)}});